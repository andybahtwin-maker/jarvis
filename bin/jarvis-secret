#!/usr/bin/env bash
# Usage:
#   jarvis-secret set KEY VALUE
#   jarvis-secret get KEY
#   jarvis-secret list
#   jarvis-secret edit       # opens in $EDITOR
#   jarvis-secret termux-sync  # (on phone) pull keystore into .env
set -euo pipefail
VAULT="$HOME/.jarvis/.env"
mkdir -p "$(dirname "$VAULT")"; touch "$VAULT"; chmod 600 "$VAULT"

case "${1:-}" in
  set)
    k="${2:?key}"; v="${3:?value}"
    # remove existing key (whole line ^KEY=...)
    if grep -qE "^${k}=" "$VAULT"; then
      tmp="$(mktemp)"; grep -vE "^${k}=" "$VAULT" > "$tmp"; mv "$tmp" "$VAULT"
    fi
    printf '%s=%q\n' "$k" "$v" >> "$VAULT"
    echo "saved $k"
    ;;
  get)
    k="${2:?key}"
    awk -F= -v K="$k" '$1==K{sub(/^'"'"'|'"'"'$/,"",$2); print $2}' "$VAULT" || true
    ;;
  list)
    cut -d= -f1 "$VAULT" | sed '/^$/d'
    ;;
  edit)
    "${EDITOR:-nano}" "$VAULT"
    ;;
  termux-sync)
    # run this *on your phone* (Termux) â€“ see phone section below
    echo "Use on phone only. See docs in the chat."
    ;;
  *)
    echo "jarvis-secret set|get|list|edit|termux-sync" >&2
    exit 2
    ;;
esac
