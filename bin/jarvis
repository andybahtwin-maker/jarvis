#!/usr/bin/env bash
set -euo pipefail

BIN="$HOME/Jarvis/workspace/bin"
SKILLS="$HOME/Jarvis/workspace/skills"
INBOX="$HOME/Jarvis/inbox"
RES="$HOME/Jarvis/results"

cmd="${1:-}"
shift || true

case "$cmd" in
  do)
    # Freeform intent -> pick a skill with llama
    prompt="$*"
    [ -z "${prompt//[$' \t\r\n']}" ] && { echo "usage: jarvis do \"your request\""; exit 2; }
    sys="You are a router. Given a user request, choose exactly one skill from:
1) summarize-clipboard  — summarize the current clipboard and produce action items.
2) note-to-notion       — append the user's text as a note to Notion (use when they say 'remember', 'note', 'add', 'log', etc.).

Return ONLY a JSON object: {\"skill\": \"<name>\", \"arg\": \"<arg-or-empty>\"}
If summarize-clipboard, leave arg empty. If note-to-notion, set arg to user's text."

    plan="$(printf 'System:\n%s\n\nUser:\n%s\n' "$sys" "$prompt" \
       | ollama run 'llama3.2:3b' 2>/dev/null \
       | sed -n '1,200p')"

    # Try to extract JSON fields naively
    skill="$(printf '%s' "$plan" | sed -n 's/.*"skill"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' | head -n1)"
    arg="$(printf '%s' "$plan" | sed -n 's/.*"arg"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' | head -n1)"

    [ -z "$skill" ] && { echo "Router failed:\n$plan" >&2; exit 1; }

    case "$skill" in
      summarize-clipboard) "$SKILLS/summarize-clipboard" ;;
      note-to-notion)      "$SKILLS/note-to-notion" "$arg" ;;
      *) echo "Unknown skill: $skill"; exit 1 ;;
    esac
    ;;

  run-inbox)
    # Execute all JSON commands in inbox (from phone or elsewhere)
    # Format: {"cmd":"note","text":"..."} or {"cmd":"summarize_clipboard"}
    shopt -s nullglob
    for f in "$INBOX"/cmd_*.json; do
      body="$(cat "$f")"
      if echo "$body" | grep -q '"cmd"[[:space:]]*:[[:space:]]*"summarize_clipboard"'; then
        "$SKILLS/summarize-clipboard" >/dev/null || true
      elif echo "$body" | grep -q '"cmd"[[:space:]]*:[[:space:]]*"note"'; then
        txt="$(printf '%s' "$body" | sed -n 's/.*"text"[[:space:]]*:[[:space:]]*"\(.*\)".*/\1/p' | head -n1)"
        "$SKILLS/note-to-notion" "$txt" >/dev/null || true
      fi
      mv "$f" "$RES/$(basename "$f")"
    done
    ;;

  *)
    cat <<USAGE
Usage:
  jarvis do "your request"     # route intent via LLaMA to a skill
  jarvis run-inbox             # execute queued JSON commands in ~/Jarvis/inbox
USAGE
    exit 2
    ;;
esac
