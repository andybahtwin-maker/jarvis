#!/usr/bin/env bash
set -euo pipefail
# Requires: ~/.notion.env with NOTION_TOKEN and NOTION_PAGE_ID
# Arg: free text to append as a paragraph
NOTE="${1:-}"
[ -z "$NOTE" ] && { echo "usage: note-to-notion \"your text\""; exit 2; }

# load secrets silently
set -a
[ -f "$HOME/.notion.env" ] && . "$HOME/.notion.env"
set +a
[ -z "${NOTION_TOKEN:-}" ] && { echo "NOTION_TOKEN missing"; exit 3; }
[ -z "${NOTION_PAGE_ID:-}" ] && { echo "NOTION_PAGE_ID missing"; exit 3; }

json_payload="$(cat <<JSON
{
  "children": [
    {
      "object": "block",
      "type": "paragraph",
      "paragraph": { "rich_text": [ { "type": "text", "text": { "content": "$NOTE" } } ] }
    }
  ]
}
JSON
)"

curl -sS -X PATCH "https://api.notion.com/v1/blocks/${NOTION_PAGE_ID}/children" \
  -H "Authorization: Bearer ${NOTION_TOKEN}" \
  -H "Content-Type: application/json" \
  -H "Notion-Version: 2022-06-28" \
  --data "$json_payload" >/dev/null

"$HOME/Jarvis/workspace/bin/jarvis-log" "note-to-notion: appended note"
echo "ok"
